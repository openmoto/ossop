services:
  eramba-db:
    image: mariadb:${ERAMBA_DB_VERSION}
    container_name: ${ERAMBA_DB_HOSTNAME}
    hostname: ${ERAMBA_DB_HOSTNAME}
    environment:
      - MYSQL_ROOT_PASSWORD=${ERAMBA_DB_ROOT_PASSWORD}
      - MYSQL_USER=${ERAMBA_DB_USER}
      - MYSQL_PASSWORD=${ERAMBA_DB_PASSWORD}
      - MYSQL_DATABASE=${ERAMBA_DB_NAME}
    volumes:
      - ../../data/eramba-db:/var/lib/mysql
    networks:
      - ossop-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${ERAMBA_DB_USER}", "-p${ERAMBA_DB_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    env_file:
      - ../../.env

  eramba-web:
    image: ghcr.io/eramba/eramba:latest
    container_name: ${ERAMBA_HOSTNAME}
    hostname: ${ERAMBA_HOSTNAME}
    depends_on:
      eramba-db:
        condition: service_healthy
    ports:
      - "${ERAMBA_PORT}:80"
    environment:
      - DB_HOST=${ERAMBA_DB_HOSTNAME}
      - DB_DATABASE=${ERAMBA_DB_NAME}
      - DB_USERNAME=${ERAMBA_DB_USER}
      - DB_PASSWORD=${ERAMBA_DB_PASSWORD}
    networks:
      - ossop-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:80 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    env_file:
      - ../../.env

networks:
  ossop-network:
    external: true
