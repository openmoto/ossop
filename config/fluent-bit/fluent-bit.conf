# Fluent Bit Configuration for OSSOP Security Stack
# This configuration collects logs from Wazuh and Suricata and ships them to OpenSearch

[SERVICE]
    # Flush logs every 5 seconds
    Flush         5
    # Set the logging level
    Log_Level     info
    # Enable HTTP server for monitoring
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    # Health check endpoint
    Health_Check  On
    # Built-in parsers file
    Parsers_File  parsers.conf

# =============================================================================
# INPUT PLUGINS - Log Collection
# =============================================================================

# Collect Wazuh alerts (JSON format)
[INPUT]
    Name              tail
    Tag               wazuh.alerts
    Path              /var/log/wazuh-alerts/*.json
    Parser            json
    DB                /fluent-bit/db/wazuh.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# Collect Suricata EVE logs (JSON format)
[INPUT]
    Name              tail
    Tag               suricata.eve
    Path              /var/log/suricata/eve.json
    Parser            json
    DB                /fluent-bit/db/suricata.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# =============================================================================
# FILTER PLUGINS - Log Processing
# =============================================================================

# Add metadata to Wazuh logs
[FILTER]
    Name                modify
    Match               wazuh.*
    Add                 log_source wazuh
    Add                 log_type security_alert
    Add                 stack_component siem

# Add metadata to Suricata logs
[FILTER]
    Name                modify
    Match               suricata.*
    Add                 log_source suricata
    Add                 log_type network_security
    Add                 stack_component ids

# Add timestamp processing for all logs
[FILTER]
    Name                modify
    Match               *
    Add                 processed_at ${HOSTNAME}

# =============================================================================
# OUTPUT PLUGINS - Send to OpenSearch
# =============================================================================

# Send Wazuh logs to OpenSearch
[OUTPUT]
    Name                opensearch
    Match               wazuh.*
    Host                ${OPENSEARCH_HOSTNAME}
    Port                ${OPENSEARCH_PORT_API}
    HTTP_User           admin
    HTTP_Passwd         admin
    Index               wazuh-alerts
    Logstash_Format     On
    Logstash_Prefix     wazuh-alerts
    Logstash_DateFormat %Y.%m.%d
    Time_Key            @timestamp
    Generate_ID         On
    Replace_Dots        On
    Retry_Limit         3
    # Suppress SSL verification for development
    tls                 Off
    tls.verify          Off
    # OpenSearch compatibility - no _type parameter
    Suppress_Type_Name  On

# Send Suricata logs to OpenSearch
[OUTPUT]
    Name                opensearch
    Match               suricata.*
    Host                ${OPENSEARCH_HOSTNAME}
    Port                ${OPENSEARCH_PORT_API}
    HTTP_User           admin
    HTTP_Passwd         admin
    Index               suricata-events
    Logstash_Format     On
    Logstash_Prefix     suricata-events
    Logstash_DateFormat %Y.%m.%d
    Time_Key            timestamp
    Generate_ID         On
    Replace_Dots        On
    Retry_Limit         3
    # Suppress SSL verification for development
    tls                 Off
    tls.verify          Off
    # OpenSearch compatibility - no _type parameter
    Suppress_Type_Name  On
